name: CI with Static TC Build

# å®šç¾©è§¸ç™¼æ¢ä»¶
on:
  push:
    paths-ignore:
      - '**.md'
  pull_request:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: 'no'
  release:
    types: [published]

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    if: ${{ !(github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) }}
    env:
      build_variant: ${{ matrix.build_variant }}
      targets: ${{ matrix.targets }}
      images_dir: /opt/images
    strategy:
      matrix:
        include:
          - build_variant: "mt7621"
            targets: "K2P"
            
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Prepare environment (Install dependencies & Fix C Compiler)
        run: |
          sudo apt update
          # å¢žåŠ  autoconf/automake ä»¥å‚™ Git å‚™æ´æ–¹æ¡ˆä½¿ç”¨
          sudo apt install -y libtool-bin gperf python3-docutils autopoint gettext bison flex wget xz-utils autoconf automake
          
          # ã€ä¿®æ­£ã€‘ç¢ºä¿å®¿ä¸»æ©Ÿ (x86_64) èƒ½é‹è¡Œ MIPS äº¤å‰ç·¨è­¯å™¨æ‰€éœ€çš„ 32 ä½è¼”åŠ©ç¨‹å¼
          sudo dpkg --add-architecture i386
          sudo apt update
          # å®‰è£ 32-bit é‹è¡Œæ™‚åŠé–‹ç™¼ä¾è³´åº«
          sudo apt install -y -qq libc6-i386 lib32z1 lib32stdc++6 lib32ncurses6 lib32z1-dev zlib1g:i386
        shell: bash
        
      # -----------------------------------------------------------
      # æ­¥é©Ÿ 1: ä¸‹è¼‰ä¸¦è¨­å®š MIPS äº¤å‰ç·¨è­¯å™¨ (ä¿®æ­£ STAGING_DIR/CC è·¯å¾‘åµæ¸¬)
      # -----------------------------------------------------------
      - name: â¬‡ï¸ ä¸‹è¼‰ä¸¦è¨­å®š MIPS äº¤å‰ç·¨è­¯å™¨ (OpenWrt SDK)
        id: toolchain_setup
        run: |
          TOOLCHAIN_VERSION="23.05.2"  
          TOOLCHAIN_FILENAME="openwrt-sdk-${TOOLCHAIN_VERSION}-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          
          # SDK ä¸‹è¼‰åŠè§£å£“é‡è©¦é‚è¼¯
          MAX_RETRIES=2
          RETRY_COUNT=0
          SDK_DOWNLOAD_URL="https://downloads.openwrt.org/releases/${TOOLCHAIN_VERSION}/targets/ramips/mt7621/${TOOLCHAIN_FILENAME}"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "å˜—è©¦ä¸‹è¼‰ OpenWrt SDK (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."
              wget "$SDK_DOWNLOAD_URL" -O sdk.tar.xz
              
              echo "è§£å£“å·¥å…·éˆ..."
              mkdir -p sdk
              if tar -Jxf sdk.tar.xz -C sdk --strip-components=1; then
                  echo "SDK è§£å£“æˆåŠŸã€‚"
                  break
              else
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                      echo "::error::éŒ¯èª¤ï¼šSDK ä¸‹è¼‰åŠè§£å£“åœ¨ ${MAX_RETRIES} æ¬¡å˜—è©¦å¾Œä»å¤±æ•—ã€‚"
                      exit 1
                  fi
                  echo "::warning::è­¦å‘Šï¼šè§£å£“å¤±æ•—ã€‚æ¸…ç†ä¸¦é‡è©¦..."
                  rm -rf sdk sdk.tar.xz  
              fi
          done

          # å°‹æ‰¾ Toolchain ç›®éŒ„ (åŒ…å« bin å’Œ lib)
          TOOLCHAIN_DIR=$(find sdk/staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -n 1)
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "::error::éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Toolchain ç›®éŒ„ã€‚"
            exit 1
          fi

          # å°‹æ‰¾ç·¨è­¯å™¨çµ•å°è·¯å¾‘ï¼šåœ¨æ­£ç¢ºçš„ bin ç›®éŒ„ä¸‹å°‹æ‰¾ gcc
          TOOLCHAIN_COMPILER_PATH=$(find ${TOOLCHAIN_DIR}/bin -type f -name "*gcc" | head -n 1)
          
          if [ -z "$TOOLCHAIN_COMPILER_PATH" ]; then
            echo "::error::éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç·¨è­¯å™¨ã€‚"
            exit 1
          fi

          TOOLCHAIN_PREFIX=$(basename "$TOOLCHAIN_COMPILER_PATH" | sed 's/gcc$//')
          
          # å°‹æ‰¾ STAGING_DIR
          STAGING_DIR=$(find sdk/staging_dir -maxdepth 1 -type d -name "target-*" | head -n 1)
          
          if [ -z "$STAGING_DIR" ]; then
            echo "::error::éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Target Staging Directory (åœ¨ sdk/staging_dir å…§)ã€‚"
            exit 1
          fi
          
          echo "åµæ¸¬åˆ°çš„å·¥å…·éˆå‰ç¶´: ${TOOLCHAIN_PREFIX}"
          echo "åµæ¸¬åˆ°çš„ Staging Dir: ${STAGING_DIR}"

          # åŒ¯å‡ºæ‰€æœ‰ç’°å¢ƒè®Šæ•¸
          echo "CROSS_COMPILE=$TOOLCHAIN_PREFIX" >> $GITHUB_ENV
          echo "CC_FULL_PATH=$TOOLCHAIN_COMPILER_PATH" >> $GITHUB_ENV
          echo "STAGING_DIR=$STAGING_DIR" >> $GITHUB_ENV
          # å„ªåŒ–ï¼šå°‡ç‰ˆæœ¬è™Ÿé›†ä¸­åœ¨æ­¤è™•å®šç¾©å’ŒåŒ¯å‡º
          echo "IPROUTE2_VERSION_LATEST=6.17.0" >> $GITHUB_ENV  
          echo "IPROUTE2_VERSION_FALLBACK=6.8.0" >> $GITHUB_ENV
          echo "TC_STATIC_PATH=${{ github.workspace }}/tc_static_bin" >> $GITHUB_ENV
          
        shell: bash

      # -----------------------------------------------------------
      # æ­¥é©Ÿ 1.5: éœæ…‹äº¤å‰ç·¨è­¯ libmnl (æœ€çµ‚ä¿®æ­£ï¼šæ¢å¾© config.cache ä¸¦ä¿ç•™å‘½ä»¤è¡Œåƒæ•¸)
      # -----------------------------------------------------------
      - name: âš™ï¸ Pre-compile and Install libmnl (æœ€çµ‚ä¿®æ­£ï¼šæ¢å¾© config.cache ä¸¦ä¿ç•™å‘½ä»¤è¡Œåƒæ•¸)
        run: |
          # --- è®Šæ•¸å®šç¾©èˆ‡æº–å‚™ ---
          VERSION_TARGET="1.2.7"  
          VERSION_FALLBACK_KNOWN="1.0.5"
          URL_TARGET="https://netfilter.org/projects/libmnl/files/libmnl-${VERSION_TARGET}.tar.xz"
          URL_FALLBACK="https://netfilter.org/projects/libmnl/files/libmnl-${VERSION_FALLBACK_KNOWN}.tar.bz2"
          LIBMNL_REPO="https://git.netfilter.org/libmnl.git"
          CLONE_DIR="libmnl-source"
          
          # 1. å‹•æ…‹å¾ž CC è·¯å¾‘æŽ¨å°Žå‡º HOST_TRIPLE
          HOST_TRIPLE=$(basename "${{ env.CC_FULL_PATH }}" | sed 's/gcc$//' | sed 's/[-]$//')
          BUILD_TRIPLE=$(/usr/share/misc/config.guess) 
          
          echo "åµæ¸¬åˆ° HOST_TRIPLE: $HOST_TRIPLE"
          echo "åµæ¸¬åˆ° BUILD_TRIPLE: $BUILD_TRIPLE"

          DOWNLOADED_FILE=""
          VERSION_TO_BUILD=""
          
          # ã€é—œéµä¿®æ­£ã€‘ï¼šå°‡ç·¨è­¯å™¨è·¯å¾‘åŒ¯å‡ºç‚ºç’°å¢ƒè®Šæ•¸
          export CC="${{ env.CC_FULL_PATH }}"
          export CFLAGS="-Os -pipe -I${{ env.STAGING_DIR }}/usr/include"
          # LDFLAGS åŒ…å« -static ä»¥å¼·åˆ¶éœæ…‹é€£çµ
          export LDFLAGS="-static -L${{ env.STAGING_DIR }}/usr/lib"

          # --- ä¸‹è¼‰èˆ‡å‚™æ´é‚è¼¯ ---
          echo "å˜—è©¦ (1/3) WGET ä¸‹è¼‰æœ€æ–°ç‰ˆæœ¬ v${VERSION_TARGET}..."
          if wget -nv "${URL_TARGET}" -O "libmnl-target.tar.xz" 2>/dev/null; then
              DOWNLOADED_FILE="libmnl-target.tar.xz"
              VERSION_TO_BUILD="${VERSION_TARGET}"
          
          elif git clone --depth 1 "${LIBMNL_REPO}" "${CLONE_DIR}" 2>/dev/null; then
              echo "âœ… WGET ä¸‹è¼‰å¤±æ•—ã€‚åŸ·è¡Œ (2/3) Git å€‰åº«å‚™æ´ä¸‹è¼‰ (æœ€æ–° Master HEAD)ã€‚"
              VERSION_TO_BUILD="${VERSION_TARGET}-git"
              
          elif wget -nv "${URL_FALLBACK}" -O "libmnl-fallback.tar.bz2" 2>/dev/null; then
              echo "âš ï¸ Git ä¸‹è¼‰å¤±æ•—ã€‚åŸ·è¡Œ (3/3) å˜—è©¦ä¸‹è¼‰ç”¨æˆ¶æä¾›çš„èˆŠç‰ˆ v${VERSION_FALLBACK_KNOWN}ã€‚"
              DOWNLOADED_FILE="libmnl-fallback.tar.bz2"
              VERSION_TO_BUILD="${VERSION_FALLBACK_KNOWN}"
              
          else
              echo "::error::éŒ¯èª¤ï¼šæ‰€æœ‰ä¸‹è¼‰å˜—è©¦å‡å¤±æ•—ã€‚"
              exit 1
          fi

          # --- æº–å‚™ç·¨è­¯ç›®éŒ„ä¸¦é€²å…¥ ---
          if [ "${VERSION_TO_BUILD}" == "${VERSION_TARGET}-git" ]; then
              # Git ä¾†æº (éœ€è¦ autogen.sh)
              echo "è™•ç† Git ä¾†æº..."
              cd "${CLONE_DIR}"
              echo "é‹è¡Œ autogen.sh ç”Ÿæˆ configure æ–‡ä»¶..."
              ./autogen.sh || { echo "::error::autogen.sh å¤±æ•—ã€‚"; exit 1; }
          else  
              # Tarball ä¾†æº (å˜—è©¦ 1 æˆ– 3)
              echo "è™•ç† Tarball ä¾†æº..."
              tar -xf "${DOWNLOADED_FILE}"
              BUILD_DIR="libmnl-${VERSION_TO_BUILD}"
              cd "${BUILD_DIR}"
          fi

          # --- åŸ·è¡Œ configure (é—œéµä¿®æ­£å€) ---
          # ðŸš¨ æ¢å¾© config.cache å¯«å…¥ï¼Œé€™æ˜¯è®“ Autoconf è…³æœ¬æŽ¥å—äº¤å‰ç·¨è­¯çš„æœ€çµ‚æ‰‹æ®µä¹‹ä¸€ã€‚
          echo "ac_cv_prog_cc_works=yes" > config.cache
          echo "ac_cv_prog_cc_c_o=yes" >> config.cache
          echo "ac_cv_prog_cc_fast_install=yes" >> config.cache
          echo "ac_cv_prog_ld_target=yes" >> config.cache
          echo "ac_cv_prog_cc_cross_compile=yes" >> config.cache
          echo "ac_cv_c_compiler_runs=yes" >> config.cache
          echo "ac_cv_sizeof_int=4" >> config.cache
          echo "ac_cv_sizeof_long=4" >> config.cache
          echo "ac_cv_sizeof_void_p=4" >> config.cache

          echo "åŸ·è¡Œ configure..."
          # é—œéµä¿®æ­£ï¼šåŒæ™‚ä½¿ç”¨ --cache-file=config.cache å’Œå°‡æ‰€æœ‰å¼·åˆ¶è®Šæ•¸ä½œç‚ºå‘½ä»¤è¡Œåƒæ•¸å‚³å…¥
          ./configure --host=$HOST_TRIPLE \
                      --build=$BUILD_TRIPLE \
                      --prefix=/usr \
                      --disable-shared \
                      --enable-static \
                      --cache-file=config.cache \
                      ac_cv_prog_cc_works=yes \
                      ac_cv_prog_cc_c_o=yes \
                      ac_cv_prog_cc_fast_install=yes \
                      ac_cv_prog_ld_target=yes \
                      ac_cv_prog_cc_cross_compile=yes \
                      ac_cv_c_compiler_runs=yes \
                      ac_cv_sizeof_int=4 \
                      ac_cv_sizeof_long=4 \
                      ac_cv_sizeof_void_p=4 || { echo "::error::libmnl configure å¤±æ•—ã€‚"; exit 1; }
          
          make || { echo "::error::libmnl make å¤±æ•—ã€‚"; exit 1; }
          make install DESTDIR="${{ env.STAGING_DIR }}" || { echo "::error::libmnl install å¤±æ•—ã€‚"; exit 1; }
          
          echo "libmnl v${VERSION_TO_BUILD} éœæ…‹ç·¨è­¯å®Œæˆä¸¦å®‰è£åˆ° ${{ env.STAGING_DIR }}/usr/lib"
          cd ..
        shell: bash

      # -----------------------------------------------------------
      # æ­¥é©Ÿ 2: éœæ…‹ç·¨è­¯ TC (ä½¿ç”¨ CC çµ•å°è·¯å¾‘åŠ libmnl é€£çµæ——æ¨™)
      # -----------------------------------------------------------
      - name: Download and Statically Compile TC
        run: |
          LATEST_VERSION="${{ env.IPROUTE2_VERSION_LATEST }}"
          FALLBACK_VERSION="${{ env.IPROUTE2_VERSION_FALLBACK }}"
          VERSION_TO_USE=""
          ARCHIVE_SUFFIX=""
          BASE_URL="https://www.kernel.org/pub/linux/utils/net/iproute2/"
          # æ§‹é€  AR è·¯å¾‘ (e.g., mipsel-openwrt-linux-musl-ar)
          AR_FULL_PATH=$(echo "${{ env.CC_FULL_PATH }}" | sed 's/gcc$/ar/')

          # å‡½æ•¸ï¼šå˜—è©¦ä¸‹è¼‰ä¸¦è¨­å®šç‰ˆæœ¬
          try_download() {
              local version=$1
              if wget -nv "${BASE_URL}iproute2-${version}.tar.xz"; then
                  VERSION_TO_USE="${version}"; ARCHIVE_SUFFIX=".tar.xz"; echo "å·²æ‰¾åˆ°ç‰ˆæœ¬ ${version} (${ARCHIVE_SUFFIX}) - å„ªå…ˆä½¿ç”¨ã€‚"; return 0
              fi
              if wget -nv "${BASE_URL}iproute2-${version}.tar.gz"; then
                  VERSION_TO_USE="${version}"; ARCHIVE_SUFFIX=".tar.gz"; echo "å·²æ‰¾åˆ°ç‰ˆæœ¬ ${version} (${ARCHIVE_SUFFIX})ã€‚" ; return 0
              fi
              return 1
          }

          # åŸ·è¡Œä¸‹è¼‰
          echo "å˜—è©¦ä¸‹è¼‰æœ€æ–°ç‰ˆæœ¬ iproute2-${LATEST_VERSION}..."
          if ! try_download "${LATEST_VERSION}"; then
              echo "::warning::è­¦å‘Šï¼šæœ€æ–°ç‰ˆæœ¬ ${LATEST_VERSION} ç„¡æ³•ä¸‹è¼‰ã€‚å˜—è©¦å›žé€€åˆ° ${FALLBACK_VERSION} ç‰ˆæœ¬ã€‚"
              if ! try_download "${FALLBACK_VERSION}"; then
                  echo "::error::éŒ¯èª¤ï¼šiproute2 ä¸‹è¼‰å¤±æ•—ã€‚" ; exit 1
              fi
          fi

          # è§£å£“
          tar -xf iproute2-${VERSION_TO_USE}${ARCHIVE_SUFFIX}
          cd iproute2-${VERSION_TO_USE}

          # éœæ…‹äº¤å‰ç·¨è­¯ tcï¼š
          # ä½¿ç”¨ LDFLAGS="-static -L... -lmnl" ä¾†å¼·åˆ¶éœæ…‹é€£çµ libmnl
          make CC="${{ env.CC_FULL_PATH }}" \
               LDFLAGS="-static -L${{ env.STAGING_DIR }}/usr/lib -lmnl" \
               CFLAGS="-I${{ env.STAGING_DIR }}/usr/include" \
               AR="${AR_FULL_PATH}" \
               SUBDIRS=tc || { echo "::error::tc make å¤±æ•—ã€‚"; exit 1; }
          
          mkdir -p ${{ env.TC_STATIC_PATH }}
          # æª¢æŸ¥ tc åŸ·è¡Œæª”æ˜¯å¦æˆåŠŸç”Ÿæˆ
          if [ ! -f "tc/tc" ]; then
            echo "::error::éŒ¯èª¤ï¼štc/tc åŸ·è¡Œæª”æœªæˆåŠŸç”Ÿæˆï¼Œéœæ…‹ç·¨è­¯å¤±æ•—ã€‚"
            exit 1
          fi
          
          cp tc/tc ${{ env.TC_STATIC_PATH }}/tc_static_mipsel
          
          echo "--- éœæ…‹é€£çµé©—è­‰çµæžœ ---"
          file ${{ env.TC_STATIC_PATH }}/tc_static_mipsel
          
          echo "IPROUTE2_VERSION=${VERSION_TO_USE}" >> $GITHUB_ENV

        shell: bash

      # -----------------------------------------------------------
      # æ­¥é©Ÿ 3: ä¸Šå‚³éœæ…‹ TC Binary ä½œç‚º Artifact
      # -----------------------------------------------------------
      - name: Upload Static TC Binary as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tc_static_mipsel_${{ env.IPROUTE2_VERSION }}  
          path: ${{ env.TC_STATIC_PATH }}/tc_static_mipsel
          retention-days: 90
          
      # -----------------------------------------------------------
      # å¾ŒçºŒéŸŒé«”ç·¨è­¯æµç¨‹
      # -----------------------------------------------------------
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug_enabled == 'yes' }}
        with:
          limit-access-to-actor: true
          
      - name: Start build
        run: |
          cd trunk
          mkdir -p ${images_dir}
          for m in $targets; do  
            fakeroot ./build_firmware_ci $m
            if [ $? -eq 0 ]; then  
              cp -f images/*.trx ${images_dir}/$m.trx
            else  
              echo "::error::éŸŒé«”ç·¨è­¯å¤±æ•—: $m"
              exit 1
            fi
            ./clear_tree_simple >/dev/null 2>&1
          done
          
      - name: Create archive
        if: ${{ github.event_name != 'release' && success() }}
        run: |
          ls -lh ${images_dir}
          GIT_VERSION=`git rev-parse --short=7 HEAD 2>/dev/null` && [ -n "$GIT_VERSION" ] && \
          image_name=images_${build_variant}_${GIT_VERSION} || image_name=images_${build_variant}
          cd ${images_dir}; md5sum *.trx |tee md5sum.txt; 7z a -mx=9 ${image_name}.7z ./*
          echo "image_name=${image_name}" >> $GITHUB_ENV
          
      - name: Upload images to Artifact
        if: ${{ github.event_name != 'release' && success() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.image_name }}
          path: ${{ env.images_dir }}/*.7z
          
      - name: Upload images to Releases
        if: ${{ github.event_name != 'release' && success() }}
        uses: svenstaro/upload-release-action@2.2.0
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ env.images_dir }}/*.trx
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
