name: CI with Static TC Build

# å®šç¾©è§¸ç™¼æ¢ä»¶
on:
  push:
    paths-ignore:
      - '**.md'
  pull_request:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: 'no'
  release:
    types: [published]

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    if: ${{ !(github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) }}
    env:
      build_variant: ${{ matrix.build_variant }}
      targets: ${{ matrix.targets }}
      images_dir: /opt/images
    strategy:
      matrix:
        include:
          - build_variant: "mt7621"
            targets: "K2P"
            
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Prepare environment (Install dependencies & Fix C Compiler)
        run: |
          sudo apt update
          # å¢žåŠ  autoconf/automake å’Œ curl
          sudo apt install -y libtool-bin gperf python3-docutils autopoint gettext bison flex wget xz-utils autoconf automake curl
          
          # å®‰è£ 32-bit é‹è¡Œæ™‚åŠé–‹ç™¼ä¾è³´åº«
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y -qq libc6-i386 lib32z1 lib32stdc++6 lib32ncurses6 lib32z1-dev zlib1g:i386
        shell: bash
        
      # -----------------------------------------------------------
      # æ­¥é©Ÿ 1: ä¸‹è¼‰ä¸¦è¨­å®š MIPS äº¤å‰ç·¨è­¯å™¨
      # -----------------------------------------------------------
      - name: â¬‡ï¸ ä¸‹è¼‰ä¸¦è¨­å®š MIPS äº¤å‰ç·¨è­¯å™¨ (OpenWrt SDK)
        id: toolchain_setup
        run: |
          TOOLCHAIN_VERSION="23.05.2"  
          TOOLCHAIN_FILENAME="openwrt-sdk-${TOOLCHAIN_VERSION}-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          
          # SDK ä¸‹è¼‰åŠè§£å£“é‡è©¦é‚è¼¯ (ä½¿ç”¨ wget)
          MAX_RETRIES=2
          RETRY_COUNT=0
          SDK_DOWNLOAD_URL="https://downloads.openwrt.org/releases/${TOOLCHAIN_VERSION}/targets/ramips/mt7621/${TOOLCHAIN_FILENAME}"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "å˜—è©¦ä¸‹è¼‰ OpenWrt SDK (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."
              wget "$SDK_DOWNLOAD_URL" -O sdk.tar.xz
              
              echo "è§£å£“å·¥å…·éˆ..."
              mkdir -p sdk
              if tar -Jxf sdk.tar.xz -C sdk --strip-components=1; then
                  echo "SDK è§£å£“æˆåŠŸã€‚"
                  break
              else
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                      echo "::error::éŒ¯èª¤ï¼šSDK ä¸‹è¼‰åŠè§£å£“åœ¨ ${MAX_RETRIES} æ¬¡å˜—è©¦å¾Œä»å¤±æ•—ã€‚"
                      exit 1
                  fi
                  echo "::warning::è­¦å‘Šï¼šè§£å£“å¤±æ•—ã€‚æ¸…ç†ä¸¦é‡è©¦..."
                  rm -rf sdk sdk.tar.xz  
              fi
          done

          # å°‹æ‰¾ Toolchain ç›®éŒ„
          TOOLCHAIN_DIR=$(find sdk/staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -n 1)
          if [ -z "$TOOLCHAIN_DIR" ]; then echo "::error::éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Toolchain ç›®éŒ„ã€‚"; exit 1; å° fi

          # å°‹æ‰¾ç·¨è­¯å™¨çµ•å°è·¯å¾‘
          TOOLCHAIN_COMPILER_PATH=$(find ${TOOLCHAIN_DIR}/bin -type f -name "*gcc" | head -n 1)
          if [ -z "$TOOLCHAIN_COMPILER_PATH" ]; then echo "::error::éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç·¨è­¯å™¨ã€‚"; exit 1; fi

          TOOLCHAIN_PREFIX=$(basename "$TOOLCHAIN_COMPILER_PATH" | sed 's/gcc$//')
          
          # å°‹æ‰¾ STAGING_DIR (Target Sysroot)
          STAGING_DIR=$(find sdk/staging_dir -maxdepth 1 -type d -name "target-*" | head -n 1)
          if [ -z "$STAGING_DIR" ]; then echo "::error::éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Target Staging Directory (åœ¨ sdk/staging_dir å…§)ã€‚"; exit 1; fi
          
          echo "CROSS_COMPILE=$TOOLCHAIN_PREFIX" >> $GITHUB_ENV
          echo "CC_FULL_PATH=$TOOLCHAIN_COMPILER_PATH" >> $GITHUB_ENV
          echo "STAGING_DIR=$STAGING_DIR" >> $GITHUB_ENV
          echo "IPROUTE2_VERSION_LATEST=6.17.0" >> $GITHUB_ENV  
          echo "IPROUTE2_VERSION_FALLBACK=6.8.0" >> $GITHUB_ENV
          echo "TC_STATIC_PATH=${{ github.workspace }}/tc_static_bin" >> $GITHUB_ENV
          
        shell: bash

      # -----------------------------------------------------------
      # æ­¥é©Ÿ 1.5: éœæ…‹äº¤å‰ç·¨è­¯ libmnl (æœ€çµ‚ä¿®æ­£ï¼šå¼·åˆ¶ GCC Sysroot)
      # -----------------------------------------------------------
      - name: âš™ï¸ Pre-compile and Install libmnl (æœ€çµ‚ä¿®æ­£)
        run: |
          # --- è®Šæ•¸å®šç¾©èˆ‡æº–å‚™ ---
          VERSION_TARGET="1.2.7"  
          URL_TARGET="https://netfilter.org/projects/libmnl/files/libmnl-${VERSION_TARGET}.tar.xz"
          LIBMNL_REPO="https://git.netfilter.org/libmnl.git"
          CLONE_DIR="libmnl-source"

          HOST_TRIPLE=$(basename "${{ env.CC_FULL_PATH }}" | sed 's/gcc$//' | sed 's/[-]$//')
          BUILD_TRIPLE=$(/usr/share/misc/config.guess)

          BUILD_DIR=""

          # ðŸš¨ é—œéµä¿®æ­£ï¼šå°‡ --sysroot æ——æ¨™åŠ å…¥ CC è®Šæ•¸ä¸­ï¼Œå¼·åˆ¶ Autoconf éˆæŽ¥ OpenWrt çš„åº«
          export CC="${{ env.CC_FULL_PATH }} --sysroot=${{ env.STAGING_DIR }}"
          export CC_FOR_BUILD="/usr/bin/gcc"  
          export CFLAGS="-Os -pipe -I${{ env.STAGING_DIR }}/usr/include"
          export LDFLAGS="-static -L${{ env.STAGING_DIR }}/usr/lib"

          echo "å˜—è©¦ä¸‹è¼‰ libmnl-v${VERSION_TARGET}..."
          # --- ä¸‹è¼‰èˆ‡ Git å‚™æ´é‚è¼¯ ---
          if curl -L --fail "${URL_TARGET}" -o "libmnl-target.tar.xz"; then
              echo "æˆåŠŸä¸‹è¼‰ libmnl-v${VERSION_TARGET}ã€‚"
              tar -xf "libmnl-target.tar.xz"
              BUILD_DIR="libmnl-${VERSION_TARGET}"
          elif git clone --depth 1 "${LIBMNL_REPO}" "${CLONE_DIR}"; then
              echo "ä¸‹è¼‰å¤±æ•—ï¼Œä½¿ç”¨ Git å€‰åº«å‚™æ´ã€‚"
              BUILD_DIR="${CLONE_DIR}"
              cd "${BUILD_DIR}"
              # å¦‚æžœæ˜¯ Git æºç¢¼ï¼Œéœ€è¦å…ˆåŸ·è¡Œ autogen.sh
              ./autogen.sh || { echo "::error::autogen.sh å¤±æ•—ã€‚"; exit 1; }
              cd ..
          else
              echo "::error::éŒ¯èª¤ï¼šlibmnl ä¸‹è¼‰å˜—è©¦å‡å¤±æ•—ã€‚è«‹æª¢æŸ¥ ${URL_TARGET} æ˜¯å¦å¯è¨ªå•ï¼Œä»¥åŠ Git å€‰åº«æ˜¯å¦æœ‰æ•ˆã€‚" 
              exit 1
          fi

          if [ -z "$BUILD_DIR" ]; then echo "::error::éŒ¯èª¤ï¼šç„¡æ³•ç¢ºå®š libmnl æ§‹å»ºç›®éŒ„ã€‚"; exit 1; fi
          
          # é€²å…¥æ§‹å»ºç›®éŒ„
          cd "${BUILD_DIR}"

          # ðŸš¨ Autoconf è¦†è“‹è®Šæ•¸ï¼Œç”¨æ–¼è·³éŽå†—é¤˜çš„ç·¨è­¯æª¢æŸ¥
          AUTOCONF_OVERRIDES="ac_cv_prog_cc_works=yes ac_cv_prog_cc_c_o=yes ac_cv_prog_cc_fast_install=yes ac_cv_prog_ld_target=yes ac_cv_prog_cc_cross_compile=yes ac_cv_c_compiler_runs=yes ac_cv_sizeof_int=4 ac_cv_sizeof_long=4 ac_cv_sizeof_void_p=4"

          echo "åŸ·è¡Œ configure (ä½¿ç”¨å¼·åˆ¶ç’°å¢ƒè®Šæ•¸ç¹žéŽæ¸¬è©¦)..."
          
          # åŸ·è¡Œ configureï¼Œä½¿ç”¨ env å‘½ä»¤åŒæ™‚è¨­å®šæ‰€æœ‰ Autoconf è¦†è“‹è®Šæ•¸
          env $AUTOCONF_OVERRIDES \
          ./configure --host=$HOST_TRIPLE \
                      --build=$BUILD_TRIPLE \
                      --prefix=/usr \
                      --disable-shared \
                      --enable-static \
                      --with-sysroot="${{ env.STAGING_DIR }}" || { echo "::error::libmnl configure å¤±æ•—ã€‚"; exit 1; }
          
          make || { echo "::error::libmnl make å¤±æ•—ã€‚"; exit 1; }
          # ä½¿ç”¨ DESTDIR å®‰è£åˆ° staging ç›®éŒ„
          make install DESTDIR="${{ env.STAGING_DIR }}" || { echo "::error::libmnl install å¤±æ•—ã€‚"; exit 1; }
          
          cd ..
        shell: bash
        
      # -----------------------------------------------------------
      # æ­¥é©Ÿ 2: éœæ…‹ç·¨è­¯ TC (iproute2)
      # -----------------------------------------------------------
      - name: Download and Statically Compile TC
        run: |
          LATEST_VERSION="${{ env.IPROUTE2_VERSION_LATEST }}"
          FALLBACK_VERSION="${{ env.IPROUTE2_VERSION_FALLBACK }}"
          VERSION_TO_USE=""
          ARCHIVE_SUFFIX=""
          BASE_URL="https://www.kernel.org/pub/linux/utils/net/iproute2/"
          AR_FULL_PATH=$(echo "${{ env.CC_FULL_PATH }}" | sed 's/gcc$/ar/')

          # å‡½æ•¸ï¼šå˜—è©¦ä¸‹è¼‰ iproute2
          try_download() {
              local version=$1
              if wget -nv "${BASE_URL}iproute2-${version}.tar.xz"; then
                  VERSION_TO_USE="${version}"; ARCHIVE_SUFFIX=".tar.xz"; echo "å·²æ‰¾åˆ°ç‰ˆæœ¬ ${version} (${ARCHIVE_SUFFIX}) - å„ªå…ˆä½¿ç”¨ã€‚"; return 0
              fi
              if wget -nv "${BASE_URL}iproute2-${version}.tar.gz"; then
                  VERSION_TO_USE="${version}"; ARCHIVE_SUFFIX=".tar.gz"; echo "å·²æ‰¾åˆ°ç‰ˆæœ¬ ${version} (${ARCHIVE_SUFFIX})ã€‚" ; return 0
              fi
              return 1
          }

          # åŸ·è¡Œä¸‹è¼‰
          echo "å˜—è©¦ä¸‹è¼‰æœ€æ–°ç‰ˆæœ¬ iproute2-${LATEST_VERSION}..."
          if ! try_download "${LATEST_VERSION}"; then
              echo "::warning::è­¦å‘Šï¼šæœ€æ–°ç‰ˆæœ¬ ${LATEST_VERSION} ç„¡æ³•ä¸‹è¼‰ã€‚å˜—è©¦å›žé€€åˆ° ${FALLBACK_VERSION} ç‰ˆæœ¬ã€‚"
              if ! try_download "${FALLBACK_VERSION}"; then
                  echo "::error::éŒ¯èª¤ï¼šiproute2 ä¸‹è¼‰å¤±æ•—ã€‚" ; exit 1
              fi
          fi

          # è§£å£“
          tar -xf iproute2-${VERSION_TO_USE}${ARCHIVE_SUFFIX}
          cd iproute2-${VERSION_TO_USE}

          # éœæ…‹äº¤å‰ç·¨è­¯ tcï¼š
          # é€™è£¡çš„ LDFLAGS åŒ…å«äº† -static å’Œ -lmnl
          make CC="${{ env.CC_FULL_PATH }} --sysroot=${{ env.STAGING_DIR }}" \
               LDFLAGS="-static -L${{ env.STAGING_DIR }}/usr/lib -lmnl" \
               CFLAGS="-I${{ env.STAGING_DIR }}/usr/include" \
               AR="${AR_FULL_PATH}" \
               SUBDIRS=tc || { echo "::error::tc make å¤±æ•—ã€‚"; exit 1; }
          
          mkdir -p ${{ env.TC_STATIC_PATH }}
          # æª¢æŸ¥ tc åŸ·è¡Œæª”æ˜¯å¦æˆåŠŸç”Ÿæˆ
          if [ ! -f "tc/tc" ]; then
            echo "::error::éŒ¯èª¤ï¼štc/tc åŸ·è¡Œæª”æœªæˆåŠŸç”Ÿæˆï¼Œéœæ…‹ç·¨è­¯å¤±æ•—ã€‚"
            exit 1
          fi
          
          cp tc/tc ${{ env.TC_STATIC_PATH }}/tc_static_mipsel
          
          echo "IPROUTE2_VERSION=${VERSION_TO_USE}" >> $GITHUB_ENV

        shell: bash

      # -----------------------------------------------------------
      # æ­¥é©Ÿ 3: ä¸Šå‚³éœæ…‹ TC Binary ä½œç‚º Artifact
      # -----------------------------------------------------------
      - name: Upload Static TC Binary as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tc_static_mipsel_${{ env.IPROUTE2_VERSION }}  
          path: ${{ env.TC_STATIC_PATH }}/tc_static_mipsel
          retention-days: 90
          
      # -----------------------------------------------------------
      # å¾ŒçºŒéŸŒé«”ç·¨è­¯æµç¨‹
      # -----------------------------------------------------------
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug_enabled == 'yes' }}
        with:
          limit-access-to-actor: true
          
      - name: Start build
        run: |
          # å‡è¨­æ‚¨çš„éŸŒé«”æ§‹å»ºè…³æœ¬ `build_firmware_ci` æœƒä½¿ç”¨ç·¨è­¯å¥½çš„ tc_static_mipsel
          cd trunk
          mkdir -p ${images_dir}
          for m in $targets; do  
            fakeroot ./build_firmware_ci $m
            if [ $? -eq 0 ]; then  
              cp -f images/*.trx ${images_dir}/$m.trx
            else  
              echo "::error::éŸŒé«”ç·¨è­¯å¤±æ•—: $m"
              exit 1
            fi
            ./clear_tree_simple >/dev/null 2>&1
          done
          
      - name: Create archive
        if: ${{ github.event_name != 'release' && success() }}
        run: |
          ls -lh ${images_dir}
          GIT_VERSION=`git rev-parse --short=7 HEAD 2>/dev/null` && [ -n "$GIT_VERSION" ] && \
          image_name=images_${build_variant}_${GIT_VERSION} || image_name=images_${build_variant}
          cd ${images_dir}; md5sum *.trx |tee md5sum.txt; 7z a -mx=9 ${image_name}.7z ./*
          echo "image_name=${image_name}" >> $GITHUB_ENV
          
      - name: Upload images to Artifact
        if: ${{ github.event_name != 'release' && success() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.image_name }}
          path: ${{ env.images_dir }}/*.7z
          
      - name: Upload images to Releases
        if: ${{ github.event_name != 'release' && success() }}
        uses: svenstaro/upload-release-action@2.2.0
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ env.images_dir }}/*.trx
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
