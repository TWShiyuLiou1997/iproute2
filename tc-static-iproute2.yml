name: Statically Compile TC (iproute2) for MIPS-uClibc

on:
  workflow_dispatch:
    inputs:
      iproute2_version:
        description: 'iproute2 ç‰ˆæœ¬ (ä¾‹å¦‚ï¼š6.7.0)'
        required: true
        default: '6.7.0'

jobs:
  build-tc:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    # -----------------------------------------------------------
    # âš ï¸ æ­¥é©Ÿ 1: é…ç½® MIPS uClibc å·¥å…·éˆ (æ­¤ç‚ºå‡è¨­)
    # -----------------------------------------------------------
    - name: â¬‡ï¸ æº–å‚™ MIPS uClibc äº¤å‰ç·¨è­¯å™¨
      # âš ï¸ æ³¨æ„ï¼šæ‚¨å¿…é ˆåœ¨æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ MIPS uClibc å·¥å…·éˆä¸‹è¼‰å’Œè§£å£“æŒ‡ä»¤
      # ç”±æ–¼ç„¡æ³•åœ¨æ¨™æº– runner ä¸Šè‡ªå‹•ç²å–æ‚¨çš„ç§æœ‰å·¥å…·éˆï¼Œæˆ‘å€‘ç”¨ä¸€å€‹ä½”ä½ç¬¦ã€‚
      # 
      # å¯¦éš›æ“ä½œä¸­ï¼Œæ‚¨å¯ä»¥æ‰‹å‹•ä¸Šå‚³å·¥å…·éˆå£“ç¸®åŒ…åˆ°æ‚¨çš„ repoï¼Œç„¶å¾Œåœ¨é€™è£¡è§£å£“ï¼š
      # run: tar -xf mips-uclibc-toolchain.tar.gz -C ${{ github.workspace }}/toolchain
      
      # ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘æ¨¡æ“¬å°‡å·¥å…·éˆçš„ bin ç›®éŒ„åŠ å…¥ PATH
      run: |
        # æ¨¡æ“¬å·¥å…·éˆå‰ç¶´ (Entware/OpenWrt å¸¸è¦‹æ ¼å¼)
        TOOLCHAIN_PREFIX="mips-openwrt-linux-uclibc-" 
        echo "CROSS_COMPILE=${TOOLCHAIN_PREFIX}" >> $GITHUB_ENV
        
        # âš ï¸ é€™è£¡é€šå¸¸éœ€è¦å°‡å·¥å…·éˆçš„ bin/ ç›®éŒ„åŠ å…¥ PATH
        # å‡è¨­æ‚¨çš„å·¥å…·éˆå®‰è£ç›®éŒ„æ˜¯ /opt/mips-uclibc-sdk/bin
        # echo "PATH=/opt/mips-uclibc-sdk/bin:$PATH" >> $GITHUB_ENV
      shell: bash

    # -----------------------------------------------------------
    # æ­¥é©Ÿ 2: ä¸‹è¼‰ä¸¦è¨­å®š iproute2 
    # -----------------------------------------------------------
    - name: â¬‡ï¸ ä¸‹è¼‰ä¸¦è§£å£“ iproute2 åŸå§‹ç¢¼
      run: |
        VERSION=${{ github.event.inputs.iproute2_version }}
        wget https://mirrors.edge.kernel.org/pub/linux/utils/iproute2/iproute2-$VERSION.tar.xz
        tar -xf iproute2-$VERSION.tar.xz
      shell: bash

    - name: ğŸ› ï¸ éœæ…‹ç·¨è­¯ TC
      run: |
        # é€²å…¥ iproute2 ç›®éŒ„
        cd iproute2-*
        
        # ç¢ºä¿ç·¨è­¯å™¨ä½¿ç”¨æ­£ç¢ºçš„å‰ç¶´
        CC_CMD="${{ env.CROSS_COMPILE }}gcc"
        
        # ç·¨è­¯è¨­å®šï¼š
        # 1. CC: æŒ‡å®šäº¤å‰ç·¨è­¯å™¨
        # 2. LDFLAGS: åŠ å…¥ -static æ——æ¨™ï¼Œå¼·åˆ¶éœæ…‹é€£çµ
        # 3. LDFLAGS: åŠ å…¥ -static æ——æ¨™ï¼Œå¼·åˆ¶éœæ…‹é€£çµ
        # 4. AR: æŒ‡å®šäº¤å‰ç·¨è­¯çš„ ar å·¥å…·
        # 5. SUBDIRS=tc: åªç·¨è­¯ tc ç›®éŒ„åŠå…¶ä¾è³´
        
        make CC="$CC_CMD" \
             LDFLAGS="-static" \
             AR="${{ env.CROSS_COMPILE }}ar" \
             SUBDIRS=tc 
             
        # ç”±æ–¼ iproute2 çš„ç·¨è­¯çµæœæœƒåœ¨ tc/ ç›®éŒ„ä¸‹ï¼Œæˆ‘å€‘è¤‡è£½å‡ºä¾†
        cp tc/tc ${{ github.workspace }}/tc_static_mips
      shell: bash

    # -----------------------------------------------------------
    # æ­¥é©Ÿ 3: é©—è­‰èˆ‡è¼¸å‡º
    # -----------------------------------------------------------
    - name: ğŸ” é©—è­‰éœæ…‹é€£çµ
      run: file tc_static_mips
      shell: bash

    - name: ğŸ“¤ ä¸Šå‚³éœæ…‹ TC åŸ·è¡Œæª”
      uses: actions/upload-artifact@v4
      with:
        name: tc-static-mips-uclibc
        path: tc_static_mips
        retention-days: 7
